<form class='{{cssClass}}' autocomplete='off'>
  <div class='modern-sheet'>
    {{!-- PERSISTENT HEADER - Always visible --}}
    <header class='ms-header'>
      {{!-- Portrait with HP overlay --}}
      <div class='ms-portrait'>
        <img src='{{actor.img}}' data-edit='img' title='{{actor.name}}' />
        <div class='ms-hp-overlay' style='height: calc(100% - {{percent system.HP.value system.HP.max}}%);'></div>
      </div>

      {{!-- Identity: Name, Attributes, HP/FP --}}
      <div class='ms-identity'>
        <h1 class='ms-name'>{{actor.name}}</h1>
        {{!-- Primary Attributes Row --}}
        <div class='ms-attrs-row'>
          <div class='ms-attr-badge rollable' data-otf='ST' title='{{localize "GURPS.attributesST"}} [{{system.attributes.ST.points}}]'>
            <span class='ms-attr-value'>{{system.attributes.ST.value}}</span>
            <span class='ms-attr-label'>ST</span>
          </div>
          <div class='ms-attr-badge rollable' data-otf='DX' title='{{localize "GURPS.attributesDX"}} [{{system.attributes.DX.points}}]'>
            <span class='ms-attr-value'>{{system.attributes.DX.value}}</span>
            <span class='ms-attr-label'>DX</span>
          </div>
          <div class='ms-attr-badge rollable' data-otf='IQ' title='{{localize "GURPS.attributesIQ"}} [{{system.attributes.IQ.points}}]'>
            <span class='ms-attr-value'>{{system.attributes.IQ.value}}</span>
            <span class='ms-attr-label'>IQ</span>
          </div>
          <div class='ms-attr-badge rollable' data-otf='HT' title='{{localize "GURPS.attributesHT"}} [{{system.attributes.HT.points}}]'>
            <span class='ms-attr-value'>{{system.attributes.HT.value}}</span>
            <span class='ms-attr-label'>HT</span>
          </div>
          <div class='ms-attr-badge rollable' data-otf='WILL' title='{{localize "GURPS.attributesWILL"}} [{{system.attributes.WILL.points}}]'>
            <span class='ms-attr-value'>{{system.attributes.WILL.value}}</span>
            <span class='ms-attr-label'>WILL</span>
          </div>
          <div class='ms-attr-badge rollable' data-otf='PER' title='{{localize "GURPS.attributesPER"}} [{{system.attributes.PER.points}}]'>
            <span class='ms-attr-value'>{{system.attributes.PER.value}}</span>
            <span class='ms-attr-label'>PER</span>
          </div>
        </div>
        {{!-- HP/FP Row --}}
        <div class='ms-hp-fp-row'>
          <div class='ms-resource ms-hp'>
            <div class='ms-resource-display' data-edit-target='hp' title='{{localize "GURPS.attributesHPNAME"}}'>
              <div class='ms-resource-bar'>
                <div class='ms-resource-fill' style='width: {{percent system.HP.value system.HP.max}}%;'></div>
              </div>
              <span class='ms-resource-text'>{{system.HP.value}}/{{system.HP.max}}</span>
            </div>
            <div class='ms-resource-edit'>
              <input type='number' name='system.HP.value' value='{{system.HP.value}}' class='ms-resource-input'/>
              <span class='ms-resource-separator'>/</span>
              <input type='number' name='system.HP.max' value='{{system.HP.max}}' class='ms-resource-input'/>
            </div>
            <button type='button' class='ms-resource-reset' data-action='reset-hp' title='Reset to max'>
              <i class='fas fa-undo'></i>
            </button>
            {{#if system.conditions.reeling}}<span class='ms-condition-badge' title='{{localize "GURPS.HP.reeling"}}'>R</span>{{/if}}
          </div>
          <div class='ms-resource ms-fp'>
            <div class='ms-resource-display' data-edit-target='fp' title='{{localize "GURPS.attributesFPNAME"}}'>
              <div class='ms-resource-bar'>
                <div class='ms-resource-fill' style='width: {{percent system.FP.value system.FP.max}}%;'></div>
              </div>
              <span class='ms-resource-text'>{{system.FP.value}}/{{system.FP.max}}</span>
            </div>
            <div class='ms-resource-edit'>
              <input type='number' name='system.FP.value' value='{{system.FP.value}}' class='ms-resource-input'/>
              <span class='ms-resource-separator'>/</span>
              <input type='number' name='system.FP.max' value='{{system.FP.max}}' class='ms-resource-input'/>
            </div>
            <button type='button' class='ms-resource-reset' data-action='reset-fp' title='Reset to max'>
              <i class='fas fa-undo'></i>
            </button>
            {{#if system.conditions.exhausted}}<span class='ms-condition-badge' title='{{localize "GURPS.FP.tired"}}'>T</span>{{/if}}
          </div>
        </div>
      </div>

      {{!-- Secondary Stats: Speed, Move, Dodge, Thrust, Swing, Senses --}}
      <div class='ms-secondary-stats'>
        <div class='ms-stat'>
          <span class='ms-stat-label'>Spd</span>
          <span class='ms-stat-value'>{{system.basicspeed.value}}</span>
        </div>
        <div class='ms-stat'>
          <span class='ms-stat-label'>Move</span>
          <span class='ms-stat-value'>{{system.basicmove.value}}</span>
        </div>
        <div class='ms-stat'>
          <span class='ms-stat-label'>Dodge</span>
          {{>dice-button otf='Dodge' level=system.currentdodge}}
        </div>
        <div class='ms-stat'>
          <span class='ms-stat-label'>Thr</span>
          {{>dice-button otf=(concat system.thrust ' dmg') level=system.thrust damage=true}}
        </div>
        <div class='ms-stat'>
          <span class='ms-stat-label'>Sw</span>
          {{>dice-button otf=(concat system.swing ' dmg') level=system.swing damage=true}}
        </div>
        <div class='ms-sense-item'>
          <i class='fas fa-eye' title='{{localize "GURPS.vision"}}'></i>
          {{>dice-button otf='Vision' level=system.vision}}
        </div>
        <div class='ms-sense-item'>
          <i class='fas fa-ear-listen' title='{{localize "GURPS.hearing"}}'></i>
          {{>dice-button otf='Hearing' level=system.hearing}}
        </div>
        <div class='ms-sense-item'>
          <i class='fas fa-wind' title='{{localize "GURPS.tastesmell"}}'></i>
          {{>dice-button otf='Taste/Smell' level=system.tastesmell}}
        </div>
        <div class='ms-sense-item'>
          <i class='fas fa-hand' title='{{localize "GURPS.touch"}}'></i>
          {{>dice-button otf='Touch' level=system.touch}}
        </div>
        <div class='ms-sense-item'>
          <i class='fas fa-ghost' title='{{localize "GURPS.frightcheck"}}'></i>
          {{>dice-button otf='Fright Check' level=system.frightcheck}}
        </div>
      </div>
    </header>

    {{!-- STATUS BAR (outside tabs) --}}
    <div class='ms-status-bar'>
      <div class='ms-status-item ms-posture-dropdown'>
        <div class='ms-posture-selected' data-posture='{{system.conditions.posture}}'>
          {{#if (eq system.conditions.posture 'prone')}}<span>{{localize 'GURPS.status.Prone'}}</span>
          {{else if (eq system.conditions.posture 'kneel')}}<span>{{localize 'GURPS.status.Kneel'}}</span>
          {{else if (eq system.conditions.posture 'crouch')}}<span>{{localize 'GURPS.status.Crouch'}}</span>
          {{else if (eq system.conditions.posture 'sit')}}<span>{{localize 'GURPS.status.Sit'}}</span>
          {{else if (eq system.conditions.posture 'crawl')}}<span>{{localize 'GURPS.status.Crawling'}}</span>
          {{else}}<span>{{localize 'GURPS.status.Standing'}}</span>
          {{/if}}
          <span class='ms-posture-icons'>
            {{#if (eq system.conditions.posture 'prone')}}<img src='systems/gurps/icons/statuses/dd-condition-prone.webp' />
            {{else if (eq system.conditions.posture 'kneel')}}<img src='systems/gurps/icons/statuses/condition-kneel.webp' />
            {{else if (eq system.conditions.posture 'crouch')}}<img src='systems/gurps/icons/statuses/condition-crouch.webp' />
            {{else if (eq system.conditions.posture 'sit')}}<img src='systems/gurps/icons/statuses/condition-sit.webp' />
            {{else if (eq system.conditions.posture 'crawl')}}<img src='systems/gurps/icons/statuses/condition-crawl.webp' />
            {{else}}<img src='systems/gurps/icons/statuses/dd-condition-standing.webp' />
            {{/if}}
            <i class='fas fa-caret-down'></i>
          </span>
        </div>
        <div class='ms-posture-options'>
          <div class='ms-posture-option' data-value='standing'>
            <span>{{localize 'GURPS.status.Standing'}}</span>
            <img src='systems/gurps/icons/statuses/dd-condition-standing.webp' />
          </div>
          {{#each (listAllPostures) as |this key|}}
          <div class='ms-posture-option' data-value='{{key}}'>
            <span>{{localize this.name}}</span>
            <img src='{{this.img}}' />
          </div>
          {{/each}}
        </div>
      </div>
      {{#if (ne system.conditions.maneuver 'undefined')}}
      <div class='ms-status-item'>
        <label>{{localize 'GURPS.maneuver'}}:</label>
        <select name='system.conditions.maneuver' {{disabled (not (inCombat this))}}>
          <option value='undefined' {{select-if system.conditions.maneuver 'undefined'}}>{{localize 'GURPS.none'}}</option>
          {{#with system.conditions.maneuver as |maneuver|}}
            {{#each (listAllManeuvers) as |this key|}}
              <option value='{{key}}' {{select-if maneuver key}}>{{localize this.label}}</option>
            {{/each}}
          {{/with}}
        </select>
      </div>
      {{/if}}
      <div class='ms-status-item'>
        <span>{{localize 'GURPS.conditionsCombatMove'}}: <strong>{{system.conditions.move}}</strong></span>
      </div>
      {{!-- ACTIVE EFFECTS TAGS (enabled only) --}}
      {{#each effects}}
      {{#unless this.disabled}}
      <span class='ms-effect-tag {{effectTagClass this}}' data-effect-id='{{this.id}}' title='{{this.name}}'>
        <span class='ms-effect-icon-wrapper'>
          {{#if this.icon}}<img src='{{this.icon}}' class='ms-effect-icon' />{{/if}}
          <button class='ms-effect-delete' data-action='delete-effect' data-effect-id='{{this.id}}' title='Delete'>
            <i class='fas fa-trash'></i>
          </button>
        </span>
        <span class='ms-tag-text'>{{this.name}}</span>
      </span>
      {{/unless}}
      {{/each}}
      <button class='ms-effect-add' data-action='add-effect' title='Add Effect'>
        <i class='fas fa-plus'></i>
      </button>
    </div>

    {{!-- TAB NAVIGATION --}}
    <nav class='ms-tabs' data-group='modern-tabs'>
      <a class='ms-tab-item' data-tab='character' title='{{localize "GURPS.attributes"}}'>
        <i class='fas fa-user'></i>
        <span>{{localize "GURPS.attributes"}}</span>
      </a>
      <a class='ms-tab-item' data-tab='combat' title='{{localize "GURPS.combatTab"}}'>
        <i class='fas fa-shield-alt'></i>
        <span>{{localize "GURPS.combatTab"}}</span>
      </a>
      <a class='ms-tab-item' data-tab='equipment' title='{{localize "GURPS.equipmentTab"}}'>
        <i class='fas fa-backpack'></i>
        <span>{{localize "GURPS.equipmentTab"}}</span>
      </a>
      <a class='ms-tab-item' data-tab='notes' title='{{localize "GURPS.notes"}}'>
        <i class='fas fa-book'></i>
        <span>{{localize "GURPS.notes"}}</span>
      </a>
    </nav>

    {{!-- TAB CONTENT --}}
    <section class='ms-body'>
      {{!-- Tab 1: Character (Main) - Single column layout --}}
      <div class='tab' data-tab='character' data-group='modern-tabs'>
        {{!-- Modifiers (Reactions & Conditional Modifiers) --}}
        {{#if (or (notEmpty system.reactions) (notEmpty system.conditionalmods))}}
        <div class='ms-section' data-section='modifiers'>
          <h3 class='ms-section-header ms-collapsible'>
            <i class='fas fa-caret-down ms-collapse-icon'></i>
            <i class='fas fa-balance-scale'></i>
            {{localize 'GURPS.modifier'}}s
            <span class='ms-section-count'>({{modifierCount}})</span>
          </h3>
          <div class='ms-section-content'>
            <div class='ms-modifiers-table'>
              <div class='ms-modifiers-header'>
                <span></span>
                <span>{{localize 'GURPS.description'}}</span>
                <span>{{localize 'GURPS.modifier'}}</span>
              </div>
              {{#each (flatlist system.reactions)}}
              <div class='ms-modifiers-row' data-key='system.reactions.{{@key}}'>
                <span class='ms-col-type'><span class='ms-type-badge ms-type-reaction' title='{{localize "GURPS.reaction"}}'>R</span></span>
                <span class='ms-col-situation'>{{{gurpslink this.situation}}}</span>
                <span class='ms-col-modifier'>{{>dice-button otf=(concat (displayNumber this.modifier) ' ' this.situation) level=this.modifier}}</span>
              </div>
              {{/each}}
              {{#each (flatlist system.conditionalmods)}}
              <div class='ms-modifiers-row' data-key='system.conditionalmods.{{@key}}'>
                <span class='ms-col-type'><span class='ms-type-badge ms-type-conditional' title='{{localize "GURPS.conditionalModifier"}}'>C</span></span>
                <span class='ms-col-situation'>{{{gurpslink this.situation}}}</span>
                <span class='ms-col-modifier'>{{>dice-button otf=(concat (displayNumber this.modifier) ' ' this.situation) level=this.modifier}}</span>
              </div>
              {{/each}}
            </div>
          </div>
        </div>
        {{/if}}

        {{!-- Skills --}}
        <div class='ms-section' data-section='skills'>
          <h3 class='ms-section-header ms-collapsible'>
            <i class='fas fa-caret-down ms-collapse-icon'></i>
            <i class='fas fa-graduation-cap'></i>
            {{localize 'GURPS.skills'}}
            <span class='ms-section-count'>({{skillCount}})</span>
          </h3>
          <div class='ms-section-content'>
            <div class='ms-skills-table'>
              <div class='ms-skills-header'>
                <span>{{localize 'GURPS.name'}}</span>
                <span>{{localize 'GURPS.level'}}</span>
                <span>RSL</span>
              </div>
              {{#each (flatlist system.skills)}}
              {{#unless isCollapsed}}
              <div class='ms-skills-row' data-key='system.skills.{{@key}}'>
                <span class='ms-col-name indent{{indent}}'>
                  <span class='ms-col-name-text'>{{this.name}}</span>
                </span>
                <span class='ms-col-level'>{{>dice-button otf=(concat 'Sk:"' this.name '"') level=this.level}}</span>
                <span class='ms-col-rsl'>{{this.relativelevel}}</span>
                {{#if this.notes}}
                <div class='ms-row-notes'>{{{gurpslinkbr this.notes}}}</div>
                {{/if}}
              </div>
              {{/unless}}
              {{else}}
              <div class='ms-empty'>{{localize 'GURPS.none'}}</div>
              {{/each}}
            </div>
          </div>
        </div>

        {{!-- Advantages, Disadvantages, Perks & Quirks --}}
        <div class='ms-section' data-section='traits'>
          <h3 class='ms-section-header ms-collapsible'>
            <i class='fas fa-caret-down ms-collapse-icon'></i>
            <i class='fas fa-list'></i>
            {{localize 'GURPS.advDisadvPerkQuirks'}}
            <span class='ms-section-count'>({{traitCount}})</span>
          </h3>
          <div class='ms-section-content'>
            <div class='ms-traits-table'>
              <div class='ms-traits-header'>
                <span>{{localize 'GURPS.name'}}</span>
                <span>OTF</span>
                <span>CP</span>
                <span>{{localize 'GURPS.pdfRef'}}</span>
              </div>
              {{#each (flatlist system.ads)}}
              {{#unless isCollapsed}}
              <div class='ms-traits-row {{pointsClass this.points}}' data-key='system.ads.{{@key}}'>
                <span class='ms-col-name indent{{indent}}'>
                  <span class='ms-col-name-text'>{{stripOtfs this.name}}</span>
                </span>
                <span class='ms-col-otf'>
                  {{#each (extractOtfs this.name this.notes)}}
                  {{>dice-button otf=this.formula text=this.text encodedAction=this.encodedAction}}
                  {{/each}}
                </span>
                <span class='ms-col-points {{pointsClass this.points}}'>[{{this.points}}]</span>
                <span class='ms-col-ref'>{{{pdflinkext this}}}</span>
                {{#if this.notes}}
                <div class='ms-row-notes'>{{{gurpslinkbr this.notes}}}</div>
                {{/if}}
              </div>
              {{/unless}}
              {{else}}
              <div class='ms-empty'>{{localize 'GURPS.none'}}</div>
              {{/each}}
            </div>
          </div>
        </div>

        {{!-- Spells if present --}}
        {{#if (notEmpty system.spells)}}
        <div class='ms-section'>
          <h3 class='ms-section-header'>
            <i class='fas fa-hat-wizard'></i>
            {{localize 'GURPS.spells'}}
          </h3>
          <div class='ms-skills-list'>
            {{#each (flatlist system.spells)}}
            <div class='ms-skill-row'>
              <div class='ms-row-header'>
                <span class='ms-skill-name'>{{this.name}}</span>
                <span class='ms-skill-rsl'>{{this.college}}</span>
                {{>dice-button otf=(concat 'Sp:"' this.name '"') level=this.level}}
              </div>
              <div class='ms-notes'>
                {{#if this.notes}}
                  {{{gurpslinkbr this.notes}}}
                {{else}}
                  <span class='ms-notes-empty'>{{localize 'GURPS.none'}}</span>
                {{/if}}
              </div>
            </div>
            {{/each}}
          </div>
        </div>
        {{/if}}
      </div>

      {{!-- Tab 2: Combat --}}
      <div class='tab' data-tab='combat' data-group='modern-tabs'>
        {{!-- Attacks Section (moved from Character tab) --}}
        <div class='ms-attacks-section'>
          {{!-- Melee Attacks --}}
          <div class='ms-section' data-section='melee'>
            <h3 class='ms-section-header ms-collapsible'>
              <i class='fas fa-caret-down ms-collapse-icon'></i>
              <i class='fas fa-sword'></i>
              {{localize 'GURPS.melee'}}
              <span class='ms-section-count'>({{meleeCount}})</span>
            </h3>
            <div class='ms-section-content'>
              <div class='ms-attacks-list ms-melee-attacks'>
                {{#if (notEmpty system.melee)}}
                <div class='ms-attack-header'>
                  <span class='ms-attack-name'>{{localize 'GURPS.melee'}}</span>
                  <span class='ms-attack-usage'>{{localize 'GURPS.usage'}}</span>
                  <span class='ms-attack-level'>{{localize 'GURPS.level'}}</span>
                  <span class='ms-attack-damage'>{{localize 'GURPS.damage'}}</span>
                  <span class='ms-attack-reach'>{{localize 'GURPS.reach'}}</span>
                  <span class='ms-attack-parry'>{{localize 'GURPS.parry'}}</span>
                </div>
                {{/if}}
                {{#each (attackflatlist system.melee)}}
                <div class='ms-attack-row'>
                  <span class='ms-attack-name'>{{>dice-button otf=(quotedAttackName "M" this) text=this.name}}</span>
                  <span class='ms-attack-usage'>{{this.mode}}</span>
                  <span class='ms-attack-level'>{{this.level}}</span>
                  <span class='ms-attack-damage'>{{>dice-button otf=this.damage text=this.damage damage=true color='var(--ms-hp)'}}</span>
                  <span class='ms-attack-reach'>{{this.reach}}</span>
                  <span class='ms-attack-parry'>{{>dice-button otf=(quotedAttackName "P" this) text=this.parry color='var(--ms-text-muted)'}}</span>
                </div>
                {{else}}
                <div class='ms-empty'>{{localize 'GURPS.none'}}</div>
                {{/each}}
              </div>
            </div>
          </div>

          {{!-- Ranged Attacks --}}
          <div class='ms-section' data-section='ranged'>
            <h3 class='ms-section-header ms-collapsible'>
              <i class='fas fa-caret-down ms-collapse-icon'></i>
              <i class='fas fa-bullseye'></i>
              {{localize 'GURPS.ranged'}}
              <span class='ms-section-count'>({{rangedCount}})</span>
            </h3>
            <div class='ms-section-content'>
              <div class='ms-attacks-list ms-ranged-attacks'>
                {{#if (notEmpty system.ranged)}}
                <div class='ms-attack-header'>
                  <span class='ms-attack-name'>{{localize 'GURPS.ranged'}}</span>
                  <span class='ms-attack-usage'>{{localize 'GURPS.usage'}}</span>
                  <span class='ms-attack-level'>{{localize 'GURPS.level'}}</span>
                  <span class='ms-attack-damage'>{{localize 'GURPS.damage'}}</span>
                  <span class='ms-attack-acc'>{{localize 'GURPS.acc'}}</span>
                  <span class='ms-attack-range'>{{localize 'GURPS.range'}}</span>
                </div>
                {{/if}}
                {{#each (attackflatlist system.ranged)}}
                <div class='ms-attack-row'>
                  <span class='ms-attack-name'>{{>dice-button otf=(quotedAttackName "R" this) text=this.name}}</span>
                  <span class='ms-attack-usage'>{{this.mode}}</span>
                  <span class='ms-attack-level'>{{this.level}}</span>
                  <span class='ms-attack-damage'>{{>dice-button otf=this.damage text=this.damage damage=true color='var(--ms-hp)'}}</span>
                  <span class='ms-attack-acc'>{{this.acc}}</span>
                  <span class='ms-attack-range'>{{this.range}}</span>
                </div>
                {{else}}
                <div class='ms-empty'>{{localize 'GURPS.none'}}</div>
                {{/each}}
              </div>
            </div>
          </div>
        </div>

        {{!-- Encumbrance & Hit Locations --}}
        <div class='ms-combat-grid'>
          {{!-- Encumbrance --}}
          <div class='ms-section'>
            <h3 class='ms-section-header'>
              <i class='fas fa-weight-hanging'></i>
              {{localize 'GURPS.encumbranceMoveDodge'}}
              {{#if (automaticEncumbrance)}}
                <i class='fas fa-lock ms-lock-icon' title='{{localize "GURPS.autoEncumbrance"}}: ON'></i>
              {{else}}
                <i class='fas fa-unlock ms-lock-icon ms-unlocked' title='{{localize "GURPS.autoEncumbrance"}}: OFF'></i>
              {{/if}}
            </h3>
            <div class='ms-encumbrance-table'>
              <div class='ms-enc-header'>
                <span></span>
                <span>{{localize 'GURPS.level'}}</span>
                <span>{{localize 'GURPS.maxload'}}</span>
                <span>{{localize 'GURPS.move'}}</span>
                <span>{{localize 'GURPS.dodge'}}</span>
              </div>
              {{#each system.encumbrance}}
              <div class='ms-enc-row {{#if current}}ms-current{{/if}} {{#unless (automaticEncumbrance)}}ms-clickable{{/unless}}' data-key='{{@key}}'>
                <span class='ms-enc-marker'>{{#if current}}â–¶{{/if}}</span>
                <span class='ms-enc-level'>{{{localizeKey (concat 'GURPS.encumbranceLevel-' @key)}}}</span>
                <span class='ms-enc-load'>{{displayDecimal weight number=1 removeZeros=true}}</span>
                <span class='ms-enc-move'>{{currentmovedisplay}}</span>
                <span class='ms-enc-dodge {{#if current}}rollable{{/if}}' {{#if current}}data-otf='Dodge'{{/if}}>
                  {{currentdodge}}
                  {{#if ../system.defenses.dodge.bonus}}
                    <span class='ms-dodge-bonus {{#if current}}rollable{{/if}}' {{#if current}}data-otf='Dodge {{{displayNumber ../system.defenses.dodge.bonus}}} DB'{{/if}}>
                      {{{displayNumber ../system.defenses.dodge.bonus}}}
                    </span>
                  {{/if}}
                </span>
              </div>
              {{/each}}
              <div class='ms-enc-mode'>
                <label for='move-mode'>{{localize 'GURPS.moveMode'}}:</label>
                <select id='move-mode' {{disabled (lt (length system.move) 2)}}>
                  {{#each system.move as |this key|}}
                    <option value='{{@key}}' {{select-if this.default true}}>{{localize this.mode}}</option>
                  {{/each}}
                </select>
              </div>
            </div>
          </div>

          {{!-- Hit Locations --}}
          <div class='ms-section'>
            <h3 class='ms-section-header'>
              <i class='fas fa-child'></i>
              {{localize 'GURPS.hitLocation'}}
            </h3>
            <div class='ms-locations-table'>
              <div class='ms-loc-header'>
                <span>{{localize 'GURPS.roll'}}</span>
                <span>{{localize 'GURPS.hitLocationWhere'}}</span>
                <span>{{localize 'GURPS.hitLocationPenalty'}}</span>
                <span>{{localize 'GURPS.hitLocationDR'}}</span>
              </div>
              {{#each system.hitlocations}}
              <div class='ms-loc-row'>
                <span class='ms-loc-roll'>{{hitlocationroll where roll ../parent}}</span>
                <span class='ms-loc-where'>{{localize (concat 'GURPS.hitLocation' where) where}}</span>
                <span class='ms-loc-penalty {{gmod penalty}}' data-name='to hit {{where}}' data-otf='{{penalty}} to hit {{where}}'>{{{displayNumber (hitlocationpenalty where penalty ../parent)}}}</span>
                <span class='ms-loc-dr {{#if (DRisModified this)}}ms-modified{{/if}}'>
                  {{#if ../document.limited}}
                    ??
                  {{else}}
                    {{dr}}{{#each split as |value key|}}<span title='{{localize key}}'>/{{value}}{{#if (ne key 'cr')}}*{{/if}}</span>{{/each}}
                  {{/if}}
                </span>
              </div>
              {{/each}}
            </div>
          </div>
        </div>
      </div>

      {{!-- Tab 3: Equipment --}}
      <div class='tab' data-tab='equipment' data-group='modern-tabs'>
        <div class='ms-section'>
          <h3 class='ms-section-header'>
            <i class='fas fa-briefcase'></i>
            {{localize 'GURPS.equipmentCarried'}} ({{toLocaleString eqtsummary.eqtlbs}} {{localize 'GURPS.lbs'}}; ${{toLocaleString eqtsummary.eqtcost}})
            <i class='fas fa-plus ms-add-icon' data-action='add-equipment' data-container='carried'></i>
          </h3>
          <div class='ms-equipment-table'>
            <div class='ms-eqt-header'>
              <span class='ms-eqt-equipped'>{{localize 'GURPS.equipmentEquipped'}}</span>
              <span class='ms-eqt-qty'>{{localize 'GURPS.equipmentQuantity'}}</span>
              <span class='ms-eqt-name'>{{localize 'GURPS.equipment'}}</span>
              <span class='ms-eqt-cost'>$</span>
              <span class='ms-eqt-weight'><i class='fas fa-weight-hanging'></i></span>
              <span class='ms-eqt-ref'>{{localize 'GURPS.pdfRef'}}</span>
              <span class='ms-eqt-actions'></span>
            </div>
            {{#each (flatlist system.equipment.carried)}}
            {{#unless isCollapsed}}
            <div class='ms-eqt-row equipmenucarried' data-key='system.equipment.carried.{{@key}}'>
              <span class='ms-eqt-equipped changeequip' data-key='system.equipment.carried.{{@key}}'>
                {{#if this.equipped}}
                  <i class='fas fa-check-circle'></i>
                {{else}}
                  <i class='far fa-circle ms-inactive'></i>
                {{/if}}
              </span>
              <span class='ms-eqt-qty'>
                <i class='fa-solid fa-circle-minus equipmentbutton' data-key='system.equipment.carried.{{@key}}' data-operation='equipment-dec'></i>
                <span>{{count}}</span>
                <i class='fa-solid fa-circle-plus equipmentbutton' data-key='system.equipment.carried.{{@key}}' data-operation='equipment-inc'></i>
              </span>
              <span class='ms-eqt-name indent{{indent}}'>
                {{#if hasContains}}<i class='fas fa-caret-down expandcollapseicon' data-key='system.equipment.carried.{{@key}}'></i>{{/if}}
                {{#if hasCollapsed}}<i class='fas fa-caret-right expandcollapseicon' data-key='system.equipment.carried.{{@key}}'></i>{{/if}}
                {{{gurpslink name}}}
                {{#if notes}}<div class='ms-eqt-notes'>{{{gurpslinkbr notes}}}</div>{{/if}}
              </span>
              <span class='ms-eqt-cost'>{{toLocaleString (toNumber cost)}}</span>
              <span class='ms-eqt-weight'>{{toLocaleString (toNumber weight)}}</span>
              <span class='ms-eqt-ref'>{{{pdflinkext this}}}</span>
              <span class='ms-eqt-actions'>
                <i class='fas fa-edit ms-action-btn' data-action='edit-equipment' data-key='system.equipment.carried.{{@key}}' title='Edit'></i>
                <i class='fas fa-trash ms-action-btn ms-delete' data-action='delete-equipment' data-key='system.equipment.carried.{{@key}}' title='Delete'></i>
              </span>
            </div>
            {{/unless}}
            {{else}}
            <div class='ms-empty'>{{localize 'GURPS.none'}}</div>
            {{/each}}
          </div>
        </div>

        <div class='ms-section'>
          <h3 class='ms-section-header'>
            <i class='fas fa-archive'></i>
            {{localize 'GURPS.equipmentOther'}} (${{toLocaleString eqtsummary.othercost}})
            <i class='fas fa-plus ms-add-icon' data-action='add-equipment' data-container='other'></i>
          </h3>
          <div class='ms-equipment-table'>
            <div class='ms-eqt-header'>
              <span class='ms-eqt-equipped'></span>
              <span class='ms-eqt-qty'>{{localize 'GURPS.equipmentQuantity'}}</span>
              <span class='ms-eqt-name'>{{localize 'GURPS.equipment'}}</span>
              <span class='ms-eqt-cost'>$</span>
              <span class='ms-eqt-weight'><i class='fas fa-weight-hanging'></i></span>
              <span class='ms-eqt-ref'>{{localize 'GURPS.pdfRef'}}</span>
              <span class='ms-eqt-actions'></span>
            </div>
            {{#each (flatlist system.equipment.other)}}
            {{#unless isCollapsed}}
            <div class='ms-eqt-row equipmenuother' data-key='system.equipment.other.{{@key}}'>
              <span class='ms-eqt-equipped'></span>
              <span class='ms-eqt-qty'>
                <i class='fa-solid fa-circle-minus equipmentbutton' data-key='system.equipment.other.{{@key}}' data-operation='equipment-dec'></i>
                <span>{{count}}</span>
                <i class='fa-solid fa-circle-plus equipmentbutton' data-key='system.equipment.other.{{@key}}' data-operation='equipment-inc'></i>
              </span>
              <span class='ms-eqt-name indent{{indent}}'>
                {{#if hasContains}}<i class='fas fa-caret-down expandcollapseicon' data-key='system.equipment.other.{{@key}}'></i>{{/if}}
                {{#if hasCollapsed}}<i class='fas fa-caret-right expandcollapseicon' data-key='system.equipment.other.{{@key}}'></i>{{/if}}
                {{{gurpslink name}}}
                {{#if notes}}<div class='ms-eqt-notes'>{{{gurpslinkbr notes}}}</div>{{/if}}
              </span>
              <span class='ms-eqt-cost'>{{toLocaleString (toNumber cost)}}</span>
              <span class='ms-eqt-weight'>{{toLocaleString (toNumber weight)}}</span>
              <span class='ms-eqt-ref'>{{{pdflinkext this}}}</span>
              <span class='ms-eqt-actions'>
                <i class='fas fa-edit ms-action-btn' data-action='edit-equipment' data-key='system.equipment.other.{{@key}}' title='Edit'></i>
                <i class='fas fa-trash ms-action-btn ms-delete' data-action='delete-equipment' data-key='system.equipment.other.{{@key}}' title='Delete'></i>
              </span>
            </div>
            {{/unless}}
            {{else}}
            <div class='ms-empty'>{{localize 'GURPS.none'}}</div>
            {{/each}}
          </div>
        </div>
      </div>

      {{!-- Tab 4: Notes (Redesigned) --}}
      <div class='tab' data-tab='notes' data-group='modern-tabs'>
        {{!-- Identity & Description Card --}}
        <div class='ms-section ms-identity-card'>
          <h3 class='ms-section-header'>
            <i class='fas fa-id-card'></i>
            {{localize 'GURPS.identity'}} & {{localize 'GURPS.description'}}
          </h3>
          <div class='ms-identity-grid'>
            <div class='ms-field'>
              <label>{{localize 'GURPS.name'}}</label>
              <input type='text' name='name' value='{{actor.name}}'/>
            </div>
            <div class='ms-field'>
              <label>{{localize 'GURPS.descriptionTitle'}}</label>
              <input type='text' name='system.description.title' value='{{system.description.title}}'/>
            </div>
            <div class='ms-field'>
              <label>{{localize 'GURPS.descriptionPlayer'}}</label>
              <input type='text' name='system.description.player' value='{{system.description.player}}'/>
            </div>
            <div class='ms-field'>
              <label>{{localize 'GURPS.descriptionGender'}}</label>
              <input type='text' name='system.description.gender' value='{{system.description.gender}}'/>
            </div>
            <div class='ms-field'>
              <label>{{localize 'GURPS.descriptionAge'}}</label>
              <input type='text' name='system.description.age' value='{{system.description.age}}'/>
            </div>
            <div class='ms-field'>
              <label>{{localize 'GURPS.descriptionHeight'}}</label>
              <input type='text' name='system.description.height' value='{{system.description.height}}'/>
            </div>
            <div class='ms-field'>
              <label>{{localize 'GURPS.descriptionWeight'}}</label>
              <input type='text' name='system.description.weight' value='{{system.description.weight}}'/>
            </div>
            <div class='ms-field'>
              <label>{{localize 'GURPS.descriptionRace'}}</label>
              <input type='text' name='system.description.race' value='{{system.description.race}}'/>
            </div>
            <div class='ms-field'>
              <label>{{localize 'GURPS.descriptionSizeModifier'}}</label>
              <input type='text' name='system.description.sizemod' value='{{system.description.sizemod}}'/>
            </div>
            <div class='ms-field'>
              <label>{{localize 'GURPS.descriptionTechLevel'}}</label>
              <input type='text' name='system.description.techlevel' value='{{system.description.techlevel}}'/>
            </div>
            <div class='ms-field'>
              <label>{{localize 'GURPS.descriptionHair'}}</label>
              <input type='text' name='system.description.hair' value='{{system.description.hair}}'/>
            </div>
            <div class='ms-field'>
              <label>{{localize 'GURPS.descriptionEyes'}}</label>
              <input type='text' name='system.description.eyes' value='{{system.description.eyes}}'/>
            </div>
            <div class='ms-field'>
              <label>{{localize 'GURPS.descriptionSkin'}}</label>
              <input type='text' name='system.description.skin' value='{{system.description.skin}}'/>
            </div>
            <div class='ms-field'>
              <label>{{localize 'GURPS.descriptionHand'}}</label>
              <input type='text' name='system.description.hand' value='{{system.description.hand}}'/>
            </div>
          </div>
        </div>

        {{!-- Points Summary Bar --}}
        <div class='ms-section ms-points-bar'>
          <h3 class='ms-section-header'>
            <i class='fas fa-coins'></i>
            {{localize 'GURPS.points'}}
          </h3>
          <div class='ms-points-row'>
            <span class='ms-points-item'><strong>{{system.totalpoints.total}}</strong> {{localize 'GURPS.pointsTotal'}}</span>
            <span class='ms-points-item'><strong>{{system.totalpoints.unspent}}</strong> {{localize 'GURPS.pointsUnspent'}}</span>
            <span class='ms-points-item'><strong>{{system.totalpoints.attributes}}</strong> {{localize 'GURPS.pointsAttributes'}}</span>
            <span class='ms-points-item'><strong>{{system.totalpoints.ads}}</strong> {{localize 'GURPS.pointsAdvantages'}}</span>
            <span class='ms-points-item'><strong>{{system.totalpoints.disads}}</strong> {{localize 'GURPS.pointsDisadvantages'}}</span>
            <span class='ms-points-item'><strong>{{system.totalpoints.skills}}</strong> {{localize 'GURPS.pointsSkills'}}</span>
            <span class='ms-points-item'><strong>{{system.totalpoints.spells}}</strong> {{localize 'GURPS.pointsSpells'}}</span>
          </div>
        </div>

        {{!-- Notes + Lifting --}}
        <div class='ms-notes-columns'>
          <div class='ms-section'>
            <h3 class='ms-section-header'>
              <i class='fas fa-sticky-note'></i>
              {{localize 'GURPS.notes'}}
              <i class='fas fa-plus ms-add-icon' data-action='add-note'></i>
            </h3>
            <div class='ms-notes-list'>
              {{#each (flatlist system.notes)}}
              {{#unless isCollapsed}}
              <div class='ms-note-row' data-key='system.notes.{{@key}}'>
                <div class='ms-note-content indent{{indent}}'>
                  {{#if hasContains}}<i class='fas fa-caret-down expandcollapseicon' data-key='system.notes.{{@key}}'></i>{{/if}}
                  {{#if hasCollapsed}}<i class='fas fa-caret-right expandcollapseicon' data-key='system.notes.{{@key}}'></i>{{/if}}
                  {{#if this.notes}}
                    {{#if title}}<strong>{{{gurpslinkbr this.title}}}</strong> {{/if}}{{{gurpslinkbr this.notes}}}
                  {{else}}
                    {{localize "GURPS.noteBlank"}}<i class='far fa-laugh-wink'></i>
                  {{/if}}
                  {{#if (isUserCreated this)}}
                    <i class='fas fa-bookmark ms-user-created' title='{{localize "GURPS.equipmentUserCreated"}}'></i>
                  {{/if}}
                </div>
                <span class='ms-note-ref'>{{{pdflinkext this}}}</span>
                <span class='ms-note-actions'>
                  <i class='fas fa-edit ms-action-btn' data-action='edit-note' data-key='system.notes.{{@key}}' title='Edit'></i>
                  <i class='fas fa-trash ms-action-btn ms-delete' data-action='delete-note' data-key='system.notes.{{@key}}' title='Delete'></i>
                </span>
              </div>
              {{/unless}}
              {{else}}
              <div class='ms-empty'>{{localize 'GURPS.none'}}</div>
              {{/each}}
            </div>
          </div>

          <div class='ms-section'>
            <h3 class='ms-section-header'>
              <i class='fas fa-dumbbell'></i>
              {{localize 'GURPS.liftingAndMovingThings'}}
            </h3>
            <div class='ms-lifting-list'>
              <span class='ms-lift-value'>{{displayDecimal system.liftingmoving.basiclift number=1 removeZeros=true}}</span>
              <span class='ms-lift-label'>{{localize 'GURPS.basicLift'}}</span>
              <span class='ms-lift-value'>{{displayDecimal system.liftingmoving.onehandedlift number=1 removeZeros=true}}</span>
              <span class='ms-lift-label'>{{localize 'GURPS.oneHandLift'}}</span>
              <span class='ms-lift-value'>{{displayDecimal system.liftingmoving.twohandedlift number=1 removeZeros=true}}</span>
              <span class='ms-lift-label'>{{localize 'GURPS.twoHandLift'}}</span>
              <span class='ms-lift-value'>{{displayDecimal system.liftingmoving.shove number=1 removeZeros=true}}</span>
              <span class='ms-lift-label'>{{localize 'GURPS.shoveAndKnockOver'}}</span>
              {{#if system.liftingmoving.runningshove}}
              <span class='ms-lift-value'>{{displayDecimal system.liftingmoving.runningshove number=1 removeZeros=true}}</span>
              <span class='ms-lift-label'>{{localize 'GURPS.runningShoveAndKnockOver'}}</span>
              {{/if}}
              <span class='ms-lift-value'>{{displayDecimal system.liftingmoving.carryonback number=1 removeZeros=true}}</span>
              <span class='ms-lift-label'>{{localize 'GURPS.carryOnBack'}}</span>
              <span class='ms-lift-value'>{{displayDecimal system.liftingmoving.shiftslightly number=1 removeZeros=true}}</span>
              <span class='ms-lift-label'>{{localize 'GURPS.shiftSlightly'}}</span>
            </div>
            <div class='ms-misc-info'>
              <div><strong>{{localize 'GURPS.sheet.personal.created'}}:</strong> {{system.description.createdon}}</div>
              <div><strong>{{localize 'GURPS.sheet.personal.modified'}}:</strong> {{system.description.modifiedon}}</div>
            </div>
          </div>
        </div>

        {{!-- Trackers --}}
        {{#if system.additionalresources.tracker.length}}
        <div class='ms-section'>
          <h3 class='ms-section-header'>
            <i class='fas fa-heartbeat'></i>
            {{localize 'GURPS.resourceTrackers'}}
            <i class='fas fa-plus ms-add-icon' data-action='add-tracker'></i>
          </h3>
          <div class='ms-trackers-list'>
            {{#each system.additionalresources.tracker}}
            {{>resource-tracker
                label=name
                resource=this
                name=(concat 'additionalresources.tracker.' (zeroFill @index 4))
                editable=true
              }}
            {{/each}}
          </div>
        </div>
        {{else}}
        <div class='ms-section'>
          <h3 class='ms-section-header'>
            <i class='fas fa-heartbeat'></i>
            {{localize 'GURPS.resourceTrackers'}}
            <i class='fas fa-plus ms-add-icon' data-action='add-tracker'></i>
          </h3>
          <div class='ms-empty'>{{localize 'GURPS.none'}}</div>
        </div>
        {{/if}}
      </div>
    </section>
  </div>
  <div class='ms-footer'>
    {{localize 'GURPS.sheet.gcs.copyright'}}
    <a href='https://gurpscharactersheet.com'>gurpscharactersheet.com</a>
  </div>
</form>
